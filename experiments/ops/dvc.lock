schema: '2.0'
stages:
  prepare:
    cmd: python ../../src/prepare.py --code-type ops_codes --train-source data/split/train-split.csv
      --val-source data/split/val-split.csv --test-source /data/share/gsg_consulting/AttentionXML/old_data/ops-combined/test.csv
      --min-label-freq 10 --max-num-labels -1 --output-dir data/prepared
    deps:
    - path: data/split/train-split.csv
      md5: b201a3254bb79334f8459c91ff656649
      size: 533596582
    - path: data/split/val-split.csv
      md5: 0e85fe782f07ac5b185ffb8fc15ed66b
      size: 5464825
    params:
      params.yaml:
        prepare.MaxNumberLabels: -1
        prepare.MinLabelFrequency: 10
    outs:
    - path: data/prepared/hospitals.txt
      md5: 2ce0ad1321eedd3f9665cebaaeee6b00
      size: 109
    - path: data/prepared/labels.txt
      md5: 2e32a781299358b9900f6e4df3da797b
      size: 17447
    - path: data/prepared/metrics.json
      md5: 4acdaab636ed7a4e655d4f1cda0494c9
      size: 452
    - path: data/prepared/test_info.csv
      md5: 4d8e0bc13cbab843992a40eb2d8ab71c
      size: 339441
    - path: data/prepared/test_labels.txt
      md5: e09b2c1cfa70dbcef1b0d0666b053b62
      size: 511858
    - path: data/prepared/test_texts.txt
      md5: 201d08d3c63858524bcdf6cc2936a5dc
      size: 131567487
    - path: data/prepared/train_info.csv
      md5: 777b283871e0da8e8ea834d43e391251
      size: 1414710
    - path: data/prepared/train_labels.txt
      md5: 9af06c32866fa01af7efe79d4820f612
      size: 2056754
    - path: data/prepared/train_texts.txt
      md5: efc6b2593577f2afdc0380f45e59cbc0
      size: 524569282
    - path: data/prepared/val_info.csv
      md5: d1bdab66ab3d4182ec0b1d08cec00bf5
      size: 12411
    - path: data/prepared/val_labels.txt
      md5: ff6104504d2c5f1f893d88c0e5a51477
      size: 22095
    - path: data/prepared/val_texts.txt
      md5: 5b4cae8894e842e0b1804ad70661db80
      size: 5373600
  preprocess:
    cmd: python ../../src/preprocess.py --train-texts data/prepared/train_texts.txt
      --train-labels data/prepared/train_labels.txt --val-texts data/prepared/val_texts.txt
      --val-labels data/prepared/val_labels.txt --test-texts data/prepared/test_texts.txt
      --test-labels data/prepared/test_labels.txt --tokenizer Spacy --max-length 256
      --pretrained-vocab ../../pretrained/gsg-fasttext/vocab.npy --pretrained-embed
      ../../pretrained/gsg-fasttext/vectors.npy --output-dir data/preprocessed
    deps:
    - path: data/prepared/test_labels.txt
      md5: e09b2c1cfa70dbcef1b0d0666b053b62
      size: 511858
    - path: data/prepared/test_texts.txt
      md5: 201d08d3c63858524bcdf6cc2936a5dc
      size: 131567487
    - path: data/prepared/train_labels.txt
      md5: 9af06c32866fa01af7efe79d4820f612
      size: 2056754
    - path: data/prepared/train_texts.txt
      md5: efc6b2593577f2afdc0380f45e59cbc0
      size: 524569282
    - path: data/prepared/val_labels.txt
      md5: ff6104504d2c5f1f893d88c0e5a51477
      size: 22095
    - path: data/prepared/val_texts.txt
      md5: 5b4cae8894e842e0b1804ad70661db80
      size: 5373600
    params:
      params.yaml:
        preprocess.embedding: gsg-fasttext
        preprocess.max_length: 256
        preprocess.tokenizer: Spacy
    outs:
    - path: data/preprocessed/metrics.json
      md5: e9b1185116e10810c87bcc182113ce66
      size: 180
    - path: data/preprocessed/test_data.pkl
      md5: ad67e79808dc71d3471f834a2ff41d63
      size: 72554680
    - path: data/preprocessed/train_data.pkl
      md5: 7a58a47d0be6391216c6e69edfc3717b
      size: 287571896
    - path: data/preprocessed/val_data.pkl
      md5: 6f8eaad8556d281aefd398917364bce4
      size: 3097144
    - path: data/preprocessed/vectors.npy
      md5: 54c3822dc195db06fdcef67177662d3e
      size: 350756128
    - path: data/preprocessed/vocab.json
      md5: ac797d317d3f0176ac7eda3f869e719b
      size: 2019977
  build_label_tree:
    cmd: PYTHONPATH='../../' python ../../src/build_label_tree.py --labels-file data/prepared/labels.txt
      --group-id-chars 0 --output-file model/label_tree.pkl
    deps:
    - path: data/prepared/labels.txt
      md5: 2e32a781299358b9900f6e4df3da797b
      size: 17447
    params:
      params.yaml:
        label_tree.group_id_chars: 0
    outs:
    - path: model/label_tree.pkl
      md5: 5a91f39d3ede26f62cd6423d8fc75232
      size: 216576
  train:
    cmd: PYTHONPATH=../../ python ../../src/train.py --train-data data/preprocessed/train_data.pkl
      --val-data data/preprocessed/val_data.pkl --vocab data/preprocessed/vocab.json
      --embed data/preprocessed/vectors.npy --label-tree model/label_tree.pkl --output-dir
      model
    deps:
    - path: data/preprocessed/train_data.pkl
      md5: 7a58a47d0be6391216c6e69edfc3717b
      size: 287571896
    - path: data/preprocessed/val_data.pkl
      md5: 6f8eaad8556d281aefd398917364bce4
      size: 3097144
    - path: data/preprocessed/vectors.npy
      md5: 54c3822dc195db06fdcef67177662d3e
      size: 350756128
    - path: data/preprocessed/vocab.json
      md5: ac797d317d3f0176ac7eda3f869e719b
      size: 2019977
    - path: model/label_tree.pkl
      md5: 5a91f39d3ede26f62cd6423d8fc75232
      size: 216576
    params:
      params.yaml:
        model.attention.type: softmax-attention
        model.dropout: 0.5
        model.encoder.hidden_size: 256
        model.encoder.num_layers: 1
        model.mlp.activation: relu
        model.mlp.bias: true
        model.mlp.hidden_layers:
        - 256
        trainer.eval_batch_size: 256
        trainer.eval_interval: 100
        trainer.num_candidates:
        trainer.num_steps: 10000
        trainer.regime: levelwise
        trainer.topk: 100
        trainer.train_batch_size: 128
    outs:
    - path: model/model.bin
      md5: 5ce36ad3d77f9fdadc165f2845e3534b
      size: 186304200
    - path: model/validation-scores.json
      md5: 77758f6ae6919d550d5e1cf495fb1c6f
      size: 545
  split:
    cmd: python ../../src/split.py --source-file /data/share/gsg_consulting/AttentionXML/old_data/ops-combined/train.csv
      --validation-size 1500 --output-dir data/split
    params:
      params.yaml:
        prepare.ValidationSize: 1500
    outs:
    - path: data/split/train-split.csv
      md5: 5aa214174c997d6f23c9f2b6f6dfc3ff
      size: 533719191
    - path: data/split/val-split.csv
      md5: a09d995d4dcbc73649f88c183b4446fc
      size: 5342216
  predict:
    cmd: PYTHONPATH=../../ python ../../src/predict.py --test-data data/preprocessed/test_data.pkl
      --model-path model/model.bin --label-tree model/label_tree.pkl --vocab data/preprocessed/vocab.json
      --embed data/preprocessed/vectors.npy --output-dir model
    deps:
    - path: data/preprocessed/test_data.pkl
      md5: ad67e79808dc71d3471f834a2ff41d63
      size: 72554680
    - path: data/preprocessed/vectors.npy
      md5: 54c3822dc195db06fdcef67177662d3e
      size: 350756128
    - path: data/preprocessed/vocab.json
      md5: ac797d317d3f0176ac7eda3f869e719b
      size: 2019977
    - path: model/label_tree.pkl
      md5: 5a91f39d3ede26f62cd6423d8fc75232
      size: 216576
    - path: model/model.bin
      md5: 5ce36ad3d77f9fdadc165f2845e3534b
      size: 186304200
    params:
      params.yaml:
        model.attention.type: softmax-attention
        model.dropout: 0.5
        model.encoder.hidden_size: 256
        model.encoder.num_layers: 1
        model.mlp.activation: relu
        model.mlp.bias: true
        model.mlp.hidden_layers:
        - 256
    outs:
    - path: model/predictions.pkl
      md5: ac6951d2bc4b96690e0ba0999e9bbf08
      size: 27817528
    - path: model/targets.pkl
      md5: 8b3b49119d33b159c9ddcc737658a10a
      size: 6398584
  evaluate:
    cmd: PYTHONPATH=../../ python ../../src/evaluate.py --model-output model/predictions.pkl
      --sparse-targets model/targets.pkl --output-dir model
    deps:
    - path: model/predictions.pkl
      md5: ac6951d2bc4b96690e0ba0999e9bbf08
      size: 27817528
    - path: model/targets.pkl
      md5: 8b3b49119d33b159c9ddcc737658a10a
      size: 6398584
    outs:
    - path: model/test-scores.csv
      md5: 4b724a432c86c00ac3d70099c35a9180
      size: 1793
    - path: model/test-scores.pdf
      md5: 3af6337938faf1e344574a9cbcb5a541
      size: 15694
